<!DOCTYPE html>
<html lang="en">
<head>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.13/css/all.css" integrity="sha384-DNOHZ68U8hZfKXOrtjWvjxusGo9WQnrNx2sqG0tfsghAvtVlRW3tvkXWZh58N9jp" crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" href="../CSS/index.css">
    <link rel="stylesheet" type="text/css" href="../CSS/times.css">
    <script src="http://localhost:3000/socket.io/socket.io.js"></script>

    <meta charset="UTF-8">
    <title>WhenIsBetter</title>
    <script>
        var socket = io.connect('http://localhost:3000');

        let cal = JSON.parse(window.sessionStorage.getItem("userCal")); // An object :D, 1D array of days
        console.log(cal);
        let currentDayIndex = 0;
        let event = window.sessionStorage.getItem("event"); // An object :D, 1D array of days
        let name = window.sessionStorage.getItem("name");
        let timesAvailableTotal = [];
        let timesAvailableDay = []; //array of days available init to FALSE
        for(let i = 0; i < 16; i++){
            timesAvailableDay.push(false)
        }

        $(document).ready(function(){
            let table = $("#calendar")[0];

            document.getElementById("test").innerHTML = 'calendar size: ' + cal.length;
            document.getElementById("currentDay").innerHTML = cal[currentDayIndex];
            document.getElementById("event").innerHTML = event;
            document.getElementById("name").innerHTML += name;

            $("body").css("display", "block");
            $("#rightPanel").slideDown("");

            //set the dates
            let date = 1;

            let r=0;
            let first = true;
            while(row=table.rows[r++])
            {
                let c=0;
                while(cell=row.cells[c++])
                {
                    console.log();
                    cell.innerHTML=date;
                    let color = '#CBCBCB';
                    if(cal.includes(date.toString())){
                        if (first){
                            color = '#FFC99B';
                            first = false;
                        }
                        console.log("FOUND!!" + date);
                        let cell = table.rows[r-1].cells[c-1];
                        //highlight selected cells
                        $(cell).css('background-color', color);
                    }
                    date++;
                }
            }
        });

        console.log("first day is: " + cal[0]);

        $(function () {
            let isMouseDown = false,
                isHighlighted;

            $("#hoursInADay td").mousedown(function () {
                let selectedIndex = ($( "td" ).index( this ) - 35);
                console.log("index of selected: " + selectedIndex);
                isMouseDown = true;
                $(this).toggleClass("highlighted");
                //if in array, remove. if not, add.
                if(timesAvailableDay[selectedIndex] === true){
                    timesAvailableDay[selectedIndex] = false;
                } else{
                    timesAvailableDay[selectedIndex] = true;
                }
                // TESTING
                let daysAvailable = 0;
                for(let p = 0; p < timesAvailableDay.length; p++){
                    if(timesAvailableDay[p] === true){
                        daysAvailable ++;
                    }
                }
                console.log("the day is: " + this.innerHTML + " calendar length: " + daysAvailable);

                isHighlighted = $(this).hasClass("highlighted");
                return false; // prevent text selection
            })
                .mouseover(function () {
                    if (isMouseDown) {
                        let selectedIndex = ($( "td" ).index( this ) - 35);
                        $(this).toggleClass("highlighted", isHighlighted);
                        if(timesAvailableDay[selectedIndex] === true){
                            timesAvailableDay[selectedIndex] = false;
                        } else{
                            timesAvailableDay[selectedIndex] = true;
                        }
                    }
                })
                .bind("selectstart", function () {
                    return false;
                })

            $(document).mouseup(function () {
                isMouseDown = false;
            });
        });

        // visually clear all hours on day cal and reset timesAvailableDay set to FALSE
        function ClearAll(){
            console.log("CLEARING ALL!");
            let x = document.getElementById("hoursInADay");
            let y = x.getElementsByTagName("td");
            for (let i = 0; i < y.length; i++) {
                y[i].classList.remove("highlighted");
                timesAvailableDay[i] = false;
            }
        }

        // visually load the already created day cal
        function setAll(){
            console.log("[...in setAll function...]");
            var x = document.getElementById("hoursInADay");
            var y = x.getElementsByTagName("td");
            for (var i = 0; i < y.length; i++) {
                if(timesAvailableDay[i] === true){
                    y[i].classList.add("highlighted");
                }
                else{
                    y[i].classList.remove("highlighted");
                }
            }
        }

        function updateCalHighlight(nextDay){
            //[ *** change the previously highlighted day back to grey *** ]
            let today = cal[currentDayIndex];
            let table = $("#calendar")[0];
            let week = today/7;
            let day = today%7;
            let cell = table.rows[parseInt(week)].cells[day - 1];
            let color = '#CBCBCB';
            $(cell).css('background-color', color); //highlight selected cells

            //[ *** update the next day's color *** ]
            if(nextDay){
                currentDayIndex++;
            } else{
                currentDayIndex--;
            }
            today = cal[currentDayIndex];
            week = today/7;
            day = today%7;
            cell = table.rows[parseInt(week)].cells[day - 1];

            color = '#FFC99B';
            $(cell).css('background-color', color);
        }

        // save current day cal to timesAvailableTotal
        function saveHours(){
            if(currentDayIndex >= timesAvailableTotal.length) { // new timesAvailableDay, push to timesAvailableTotal
                console.log("pushing... " + timesAvailableDay + " to index: " + timesAvailableTotal.length);
                let arrayCopy = timesAvailableDay.slice();
                timesAvailableTotal.push(arrayCopy);
            } else{ //overwrite the old calendar
                timesAvailableTotal[currentDayIndex] = timesAvailableDay;
            }
        }

        function updateCal(isNextDay){
            //[ *** save the previous calendar before moving to new one *** ]
            saveHours();
            //[ *** update the coloring on calendar. *NOTE: updateCalHighlight also increments/decrements on day *** ]
            updateCalHighlight(isNextDay);

            //[ *** set up the hours cal to work on *** ]
            if(currentDayIndex >= timesAvailableTotal.length){ // work on new blank day
                console.log("currentDayIndex: " + currentDayIndex + " timesAvailableTotal: " + timesAvailableTotal.length);
                ClearAll();
            }
            else { // load and update already created day
                console.log("currentDayIndex: " + currentDayIndex + " timesAvailableTotal: " + timesAvailableTotal.length);
                timesAvailableDay = timesAvailableTotal[currentDayIndex];
                console.log(timesAvailableDay);
                console.log(timesAvailableTotal);
                setAll();
            }
        }

        function arrow(isNextButton){
            console.log("[...in arrow function...]");
            //make sure at least one time is selected
            if(timesAvailableDay.length === 0){
                alert('Please select at least one time.');
                return;
            }
            // check legality of move (forward or backwards)
            if(isNextButton){
                //end of calendar, cannot access more
                if((currentDayIndex + 1) >= cal.length) {
                    alert("error, end of calendar " + (currentDayIndex + 1) + " is over the limit of " + cal.length);
                    return;
                }
            } else{
                if((currentDayIndex - 1) < 0){
                    alert("error, end of calendar " + (currentDayIndex - 1) + " is under the limit of 0");
                    return;
                }
            }
            // must be legal to move in calendar, let's continue
            updateCal(isNextButton);
            document.getElementById("currentDay").innerHTML = cal[currentDayIndex];

        }

        function addNewUser(name, event, timesAvailableTotal) {
            console.log("[ in addNewUser function ]");
            var userData = {
                name: name,
                event: event,
                cal: timesAvailableTotal
            };
            console.log(userData);
            socket.emit('saveUser', JSON.stringify(userData));
        }

        function finished(){
            console.log("[...finished picking times... saving to database]");
            console.log(cal);
            saveHours();
            window.sessionStorage.setItem("userDays", JSON.stringify(timesAvailableTotal));
            var userDays = JSON.parse(sessionStorage.getItem("userDays")); // An object :D
            console.log("user hours available length: " + userDays.length);
            window.location.href = "getCode.html";
            // save to mongoDB...?
            addNewUser(name, event, timesAvailableTotal);
        }

    </script>
</head>
<body>

<div id = "test"></div>

<div id = "rightPanel">
    <div id = "event" class = "title italic marginLeft"></div>
    <div id = "name" class = "title2 italic marginLeft">by </div>
    <br>
    <!--right panel calendar -->

    <table cellpadding="0" cellspacing="0" id="calendar" class = "">
        <tr>
            <td></td><td></td><td></td><td></td><td></td><td></td><td></td>
        </tr>
        <tr>
            <td></td><td></td><td></td><td></td><td></td><td></td><td></td>

        </tr>
        <tr>
            <td></td><td></td><td></td><td></td><td></td><td></td><td></td>

        </tr>
        <tr>
            <td></td><td></td><td></td><td></td><td></td><td></td><td></td>

        </tr>
        <tr>
            <td></td><td></td><td></td><td></td><td></td><td></td><td></td>

        </tr>
    </table>

</div>

    <table cellpadding="0" cellspacing="0" id="hoursInADay" class = "">
    <div id = "day" style="top: 20px" class = "title">July <div id = "currentDay"></div></div>

    <tr><td></td></tr><tr><td></td></tr><tr><td></td></tr><tr><td></td></tr>
    <tr><td></td></tr><tr><td></td></tr><tr><td></td></tr><tr><td></td></tr>
    <tr><td></td></tr><tr><td></td></tr><tr><td></td></tr><tr><td></td></tr>
    <tr><td></td></tr><tr><td></td></tr><tr><td></td></tr><tr><td></td></tr>
    </table>

    <button id = "prevButton" onclick="arrow(false);"> <i id="prev" class="fas fa-angle-left"></i> </button>
    <button id = "nextButton" onclick="arrow(true);"> <i id="next" class="fas fa-angle-right"></i> </button>

    <button id = "clearAll" class = "button" onclick="ClearAll();">Clear all</button>

    <button id = "done" class = "button" onclick="finished();">I'm done!</button>

    <script>
        //set the dates
        var timetable=document.getElementById("hoursInADay");
        var date = 8;

        var r=0;
        while(row=timetable.rows[r++])
        {
            var c=0;
            while(cell=row.cells[c++])
            {
                if(date>12)
                {
                    cell.innerHTML=(date-12) +":00 PM"; // do sth with cell
                }
                else{
                    cell.innerHTML=date+":00 AM"; // do sth with cell
                }
                date++;
            }
        }

    </script>

</body>
</html>