<!DOCTYPE html>
<html lang="en">
<head>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.13/css/all.css" integrity="sha384-DNOHZ68U8hZfKXOrtjWvjxusGo9WQnrNx2sqG0tfsghAvtVlRW3tvkXWZh58N9jp" crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" href="../CSS/index.css">
    <link rel="stylesheet" type="text/css" href="../CSS/times.css">
    <script src="../JS/user.js"></script>

    <meta charset="UTF-8">
    <title>WhenIsBetter</title>
    <script>
        let cal = JSON.parse(window.sessionStorage.getItem("userCal")); // An object :D, 1D array of days
        console.log(cal);
        let currentDay = 0;
        let event = window.sessionStorage.getItem("event"); // An object :D, 1D array of days
        let name = window.sessionStorage.getItem("name");
        let timesAvailableTotal = [];
        let timesAvailableDay = new Set([]); //array of days available
        $(document).ready(function(){
            let table = $("#calendar")[0];

            document.getElementById("test").innerHTML = 'calendar size: ' + cal.length;
            document.getElementById("currentDay").innerHTML = cal[currentDay];
            document.getElementById("event").innerHTML = event;
            document.getElementById("name").innerHTML += name;

            $("body").css("display", "block");
            $("#rightPanel").slideDown("");

            //set the dates
            let date = 1;

            let r=0;
            let first = true;
            while(row=table.rows[r++])
            {
                let c=0;
                while(cell=row.cells[c++])
                {
                    console.log();
                    cell.innerHTML=date;
                    let color = '#CBCBCB';
                    if(cal.includes(date.toString())){
                        if (first){
                            color = '#FFC99B';
                            first = false;
                        }
                        console.log("FOUND!!" + date);
                        let cell = table.rows[r-1].cells[c-1];
                        //highlight selected cells
                        $(cell).css('background-color', color);
                    }
                    date++;
                }
            }
        });

        console.log("first day is: " + cal[0]);

        $(function () {
            let isMouseDown = false,
                isHighlighted;

            $("#hoursInADay td").mousedown(function () {
                isMouseDown = true;
                $(this).toggleClass("highlighted");
                //if in array, remove. if not, add.
                if(timesAvailableDay.has(this.innerHTML)){
                    timesAvailableDay.delete(this.innerHTML);
                } else{
                    timesAvailableDay.add(this.innerHTML);
                }
                console.log("the day is: " + this.innerHTML + " calendar length: " + timesAvailableDay.size);

                isHighlighted = $(this).hasClass("highlighted");
                return false; // prevent text selection
            })
                .mouseover(function () {
                    if (isMouseDown) {
                        $(this).toggleClass("highlighted", isHighlighted);
                        if(timesAvailableDay.has(this.innerHTML)){
                            timesAvailableDay.delete(this.innerHTML);
                        } else{
                            timesAvailableDay.add(this.innerHTML);
                        }
                    }
                })
                .bind("selectstart", function () {
                    return false;
                })

            $(document).mouseup(function () {
                isMouseDown = false;
            });
        });

        //clear all button
        function ClearAll(){
            var x = document.getElementById("hoursInADay");
            var y = x.getElementsByTagName("td");
            for (var i = 0; i < y.length; i++) {
                y[i].classList.remove("highlighted");
            }
            timesAvailableDay.clear();
        }

        function updateCal(){
            let table = $("#calendar")[0];
            let week = currentDay/7;
            let day = currentDay%7;
            let cell = table.rows[week - 1].cells[day - 1];
            //highlight selected cells
            let color = 'lightGray';
            $(cell).css('background-color', color);

            //add new day
            if(currentDay >= timesAvailableTotal.length){
                let timesArray = Array.from(timesAvailableDay);
                timesAvailableTotal.push(timesArray);
                currentDay++;
            }
            //update already created day
            else {
                //load that day
                timesAvailableDay = new Set(timesAvailableTotal[currentDay]);

                let timesArray = Array.from(timesAvailableDay);
                timesAvailableTotal[currentDay] = timesArray;
                currentDay++;
            }
            week = currentDay/7;
            day = currentDay%7;
            cell = table.rows[week - 1].cells[day - 1];

            color = '#CBCBCB';
            $(cell).css('background-color', color);
        }

        function next(){
            console.log("[...in next function...]");
            //make sure at least one time is selected
            if(timesAvailableDay.size == 0){
                alert('Please select at least one time.');
                return;
            }
            //end of calendar, cannot access more
            if(currentDay + 1 >= cal.length) {
                alert("error, end of calendar " + (currentDay + 1) + " is over the limit of " + cal.length);
                return;
            }

            updateCal();
            ClearAll();
            document.getElementById("currentDay").innerHTML = cal[currentDay];
        }

        function prev(){
            console.log("[...in back function...]");
            //if a new calendar has been made

            if(timesAvailableDay.length != 0){
                let timesArray = Array.from(timesAvailableDay);
                timesAvailableTotal[currentDay] = timesArray;
            }
            if(currentDay - 1 >= 0){
                currentDay --;
            } else{
                alert("error, end of calendar " + (currentDay - 1) + " is under the limit of 0");
                return;
            }
            ClearAll();
        }

        function finished(){
            console.log("[...finished picking times... saving to database]");
            console.log(cal);
            updateCal();
            window.sessionStorage.setItem("userDays", JSON.stringify(timesAvailableTotal));
            var userDays = JSON.parse(sessionStorage.getItem("userDays")); // An object :D
            console.log("user hours available length: " + userDays.length);
            // window.location.href = "getCode.html";
            // save to mongoDB...?
            addNewUser(name, event, timesAvailableTotal);
        }

    </script>
</head>
<body>

<div id = "test"></div>

<div id = "rightPanel">
    <div id = "event" class = "title italic marginLeft"></div>
    <div id = "name" class = "title2 italic marginLeft">by </div>
    <br>
    <!--right panel calendar -->

    <table cellpadding="0" cellspacing="0" id="calendar" class = "">
        <tr>
            <td></td><td></td><td></td><td></td><td></td><td></td><td></td>
        </tr>
        <tr>
            <td></td><td></td><td></td><td></td><td></td><td></td><td></td>

        </tr>
        <tr>
            <td></td><td></td><td></td><td></td><td></td><td></td><td></td>

        </tr>
        <tr>
            <td></td><td></td><td></td><td></td><td></td><td></td><td></td>

        </tr>
        <tr>
            <td></td><td></td><td></td><td></td><td></td><td></td><td></td>

        </tr>
    </table>

</div>

    <table cellpadding="0" cellspacing="0" id="hoursInADay" class = "">
    <div id = "day" style="top: 20px" class = "title">July <div id = "currentDay"></div></div>

    <tr><td></td></tr><tr><td></td></tr><tr><td></td></tr><tr><td></td></tr>
    <tr><td></td></tr><tr><td></td></tr><tr><td></td></tr><tr><td></td></tr>
    <tr><td></td></tr><tr><td></td></tr><tr><td></td></tr><tr><td></td></tr>
    <tr><td></td></tr><tr><td></td></tr><tr><td></td></tr><tr><td></td></tr>
    </table>

    <button id = "prevButton" onclick="prev();"> <i id="prev" class="fas fa-angle-left"></i> </button>
    <button id = "nextButton" onclick="next();"> <i id="next" class="fas fa-angle-right"></i> </button>

    <button id = "clearAll" class = "button" onclick="ClearAll();">Clear all</button>

    <button id = "done" class = "button" onclick="finished();">I'm done!</button>

    <script>
        //set the dates
        var timetable=document.getElementById("hoursInADay");
        var date = 8;

        var r=0;
        while(row=timetable.rows[r++])
        {
            var c=0;
            while(cell=row.cells[c++])
            {
                if(date>12)
                {
                    cell.innerHTML=(date-12) +":00 PM"; // do sth with cell
                }
                else{
                    cell.innerHTML=date+":00 AM"; // do sth with cell
                }
                date++;
            }
        }

    </script>

</body>
</html>