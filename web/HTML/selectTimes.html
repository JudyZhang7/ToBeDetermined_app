<!DOCTYPE html>
<html lang="en">
<head>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.13/css/all.css" integrity="sha384-DNOHZ68U8hZfKXOrtjWvjxusGo9WQnrNx2sqG0tfsghAvtVlRW3tvkXWZh58N9jp" crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" href="../CSS/index.css">
    <link rel="stylesheet" type="text/css" href="../CSS/times.css">

    <meta charset="UTF-8">
    <title>WhenIsBetter</title>
    <script>
        var cal = JSON.parse(window.sessionStorage.getItem("userCal")); // An object :D, 1D array of days
        console.log(cal);
        var currentDay = 0;
        var endDay = cal.length;

        var timesAvailableTotal = [];
        var timesAvailableDay = new Set([]); //array of days available

        console.log("first day is: " + cal[0]);
        window.onload = function(){
            document.getElementById("test").innerHTML = 'calendar size: ' + cal.length;
            document.getElementById("currentDay").innerHTML = cal[currentDay];
        }

        $(function () {
            var isMouseDown = false,
                isHighlighted;

            $("#calendar td").mousedown(function () {
                isMouseDown = true;
                $(this).toggleClass("highlighted");
                //if in array, remove. if not, add.
                if(timesAvailableDay.has(this.innerHTML)){
                    timesAvailableDay.delete(this.innerHTML);
                } else{
                    timesAvailableDay.add(this.innerHTML);
                }
                console.log("the day is: " + this.innerHTML + " calendar length: " + timesAvailableDay.size);

                isHighlighted = $(this).hasClass("highlighted");
                return false; // prevent text selection
            })
                .mouseover(function () {
                    if (isMouseDown) {
                        $(this).toggleClass("highlighted", isHighlighted);
                        if(timesAvailableDay.has(this.innerHTML)){
                            timesAvailableDay.delete(this.innerHTML);
                        } else{
                            timesAvailableDay.add(this.innerHTML);
                        }
                    }
                })
                .bind("selectstart", function () {
                    return false;
                })

            $(document).mouseup(function () {
                isMouseDown = false;
            });
        });

        //clear all button
        function ClearAll(){
            var x = document.getElementById("calendar");
            var y = x.getElementsByTagName("td");
            for (var i = 0; i < y.length; i++) {
                y[i].classList.remove("highlighted");
            }
            timesAvailableDay.clear();
        }

        function next(){
            console.log("[...in next function...]");
            //make sure at least one time is selected
            if(timesAvailableDay.size == 0){
                alert('Please select at least one time.');
                return;
            }
            //add new
            if(currentDay >= timesAvailableTotal.length){
                let timesArray = Array.from(timesAvailableDay);
                timesAvailableTotal.push(timesArray);
                currentDay++;
            }
            //update old
            else if (currentDay < timesAvailableTotal.length){
                let timesArray = Array.from(timesAvailableDay);
                timesAvailableTotal[currentDay] = timesArray;
                currentDay++;
            }
            else{
                window.sessionStorage.setItem("userDays", JSON.stringify(timesAvailableTotal));
                var userDays = JSON.parse(sessionStorage.getItem("userDays")); // An object :D
                console.log("user hours available length: " + userDays.length);
                // window.location.href = "getCode.html";
            }
            ClearAll();
            document.getElementById("currentDay").innerHTML = cal[currentDay];
        }

        function back(){
            console.log("[...in back function...]");
            if(currentDay - 1 >= 0){
                currentDay --;
            }
        }

        function finished(){
            console.log("[...finished picking times... saving to database]");
            console.log(cal);
        }

    </script>
</head>
<body>

<div id = "test"></div>

<table cellpadding="0" cellspacing="0" id="calendar" class = "">
    <div id = "day" style="top: 20px" class = "title">July <div id = "currentDay"></div></div>

    <tr><td></td></tr><tr><td></td></tr><tr><td></td></tr><tr><td></td></tr>
    <tr><td></td></tr><tr><td></td></tr><tr><td></td></tr><tr><td></td></tr>
    <tr><td></td></tr><tr><td></td></tr><tr><td></td></tr><tr><td></td></tr>
    <tr><td></td></tr><tr><td></td></tr><tr><td></td></tr><tr><td></td></tr>
</table>

    <button id = "nextButton" onclick="next();"> <i id="next" class="fas fa-angle-right"></i> </button>

    <button id = "clearAll" class = "button" onclick="ClearAll();">Clear all</button>

    <button id = "done" class = "button" onclick="finished();">I'm done!</button>

    <script>
        //set the dates
        var table=document.getElementById("calendar");
        var date = 8;

        var r=0;
        while(row=table.rows[r++])
        {
            var c=0;
            while(cell=row.cells[c++])
            {
                if(date>12)
                {
                    cell.innerHTML=(date-12) +":00 PM"; // do sth with cell
                }
                else{
                    cell.innerHTML=date+":00 AM"; // do sth with cell
                }
                date++;
            }
        }

    </script>
</body>
</html>